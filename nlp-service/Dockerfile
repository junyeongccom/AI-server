FROM python:3.11-slim

# í™˜ê²½ë³€ìˆ˜ ì„¤ì • - Python ì¶œë ¥ ë²„í¼ë§ ë¹„í™œì„±í™” ë° í•œê¸€ ì¸ì½”ë”© ì„¤ì •
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONIOENCODING=utf-8 \
    LANG=C.UTF-8 \
    PYTHONTRACEMALLOC=1 \
    PYTHONFAULTHANDLER=1 \
    LOG_LEVEL=DEBUG

# í•„ìˆ˜ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (apt-get)
RUN apt-get update && \
    # Java ì„¤ì¹˜ (KoNLPyì˜ OKT í˜•íƒœì†Œ ë¶„ì„ê¸°ê°€ JVM í•„ìš”)
    # default-jdkëŠ” ì‹œìŠ¤í…œì— ë§ëŠ” ê¸°ë³¸ JDKë¥¼ ì„¤ì¹˜í•´ì¤Œ (python:3.11-slimì—ì„œëŠ” openjdk-11-jdk íŒ¨í‚¤ì§€ë¥¼ ì§ì ‘ ì°¾ì„ ìˆ˜ ì—†ìŒ)
    apt-get install -y --no-install-recommends \
    default-jdk \
    # ê¸°íƒ€ í•„ìš”í•œ ì‹œìŠ¤í…œ ì˜ì¡´ì„± 
    build-essential \
    g++ \
    gcc \
    # ë””ë²„ê¹…ìš© ë„êµ¬ ì¶”ê°€
    procps \
    curl \
    nano \
    && \
    # ìºì‹œ ì •ë¦¬ ë° ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°ë¡œ ì´ë¯¸ì§€ í¬ê¸° ìµœì í™”
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# requirements.txt íŒŒì¼ ë³µì‚¬
COPY requirements.txt .

# ëª¨ë“  íŒŒì´ì¬ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN pip install --no-cache-dir -r requirements.txt

# NLTK ë°ì´í„° ë‹¤ìš´ë¡œë“œ (punkt ë°ì´í„°ì…‹ì€ tokenizeì— í•„ìš”)
RUN python -m nltk.downloader -d /usr/local/share/nltk_data punkt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY app ./app

# í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
RUN mkdir -p output original && \
    chmod -R 777 output original

# ë””ë²„ê¹…: ë””ë ‰í† ë¦¬ êµ¬ì¡° ì¶œë ¥
RUN ls -la /app && \
    ls -la /app/original && \
    ls -la /app/output && \
    ls -la /app/app && \
    echo "Java version:" && \
    java -version && \
    echo "Python version:" && \
    python --version && \
    echo "NLTK data path:" && \
    python -c "import nltk; print(nltk.data.path)"

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 9004

# ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
COPY <<EOF /app/entrypoint.sh
#!/bin/bash
set -e

echo "âœ¨ Starting NLP service..."
echo "ğŸ“‚ Current directory: \$(pwd)"
echo "ğŸ“‚ Directory contents:"
ls -la
echo "ğŸ“‚ Original directory contents:"
ls -la original
echo "ğŸ“‚ Output directory contents:"
ls -la output
echo "ğŸš€ Starting server..."

# ì„œë²„ ì‹¤í–‰
exec uvicorn app.main:app --host 0.0.0.0 --port 9004
EOF

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
RUN chmod +x /app/entrypoint.sh

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ëª…ë ¹
CMD ["/app/entrypoint.sh"]
